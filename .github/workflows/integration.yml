name: Integration Tests

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'scripts/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test-android:
    name: Android Integration Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        api-level: [30, 33]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}

      - name: Build native binary
        run: cargo build --release --features native-binary

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          script: echo "Generated AVD snapshot for caching."

      - name: Run integration tests with emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            # Wait for emulator to be fully booted
            adb wait-for-device
            adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'

            # List devices
            adb devices

            # Run integration tests
            chmod +x scripts/test-all-tools.sh
            ./scripts/test-all-tools.sh || true

            # Run specific MCP tests
            export DEVICE_ID=$(adb devices | grep -v "List" | awk '{print $1}' | head -1)
            echo "Testing with device: $DEVICE_ID"

            # Test device listing
            echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"mobile_device_mcp_list_available_devices","arguments":{}}}' | \
              ./target/release/mobile-device-mcp-server | grep -q "emulator"

            # Test screenshot
            echo '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"mobile_device_mcp_take_screenshot","arguments":{"device_id":"'$DEVICE_ID'","platform":"android"}}}' | \
              ./target/release/mobile-device-mcp-server | grep -q "image"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-integration-results-${{ matrix.os }}-api${{ matrix.api-level }}
          path: |
            *.log
            screenshots/
          if-no-files-found: ignore

  test-ios-simulator:
    name: iOS Simulator Integration Tests
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        device: ['iPhone 15', 'iPhone 15 Pro', 'iPad Pro (12.9-inch) (6th generation)']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: macos-cargo-ios-integration-${{ hashFiles('**/Cargo.lock') }}

      - name: Build native binary with iOS support
        run: cargo build --release --features "native-binary,ios-support"

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Boot iOS simulator
        run: |
          DEVICE_UUID=$(xcrun simctl list devices available | grep "${{ matrix.device }}" | head -1 | grep -oE '[0-9A-F-]{36}')
          echo "Booting device: $DEVICE_UUID"
          xcrun simctl boot "$DEVICE_UUID" || echo "Device already booted"

          # Wait for boot to complete
          for i in {1..30}; do
            if xcrun simctl list devices | grep "$DEVICE_UUID" | grep -q "Booted"; then
              echo "Device booted successfully"
              break
            fi
            sleep 2
          done

          # Store device UUID for later steps
          echo "DEVICE_UUID=$DEVICE_UUID" >> $GITHUB_ENV

      - name: Run iOS integration tests
        run: |
          # Give simulator time to fully initialize
          sleep 10

          # List devices test
          echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"mobile_device_mcp_list_available_devices","arguments":{}}}' | \
            ./target/release/mobile-device-mcp-server | tee list-output.json

          cat list-output.json | grep -q "${{ matrix.device }}"

          # Take screenshot test
          echo '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"mobile_device_mcp_take_screenshot","arguments":{"device_id":"'$DEVICE_UUID'","platform":"ios"}}}' | \
            ./target/release/mobile-device-mcp-server | tee screenshot-output.json

          cat screenshot-output.json | grep -q "image"

          # Get screen size test
          echo '{"jsonrpc":"2.0","id":3,"method":"tools/call","params":{"name":"mobile_device_mcp_get_screen_size","arguments":{"device_id":"'$DEVICE_UUID'","platform":"ios"}}}' | \
            ./target/release/mobile-device-mcp-server | tee screen-size-output.json

          cat screen-size-output.json | grep -q "width"

      - name: Shutdown simulator
        if: always()
        run: |
          if [ -n "$DEVICE_UUID" ]; then
            xcrun simctl shutdown "$DEVICE_UUID" || true
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-integration-results-${{ matrix.device }}
          path: |
            *.json
            *.log
            screenshots/
          if-no-files-found: ignore

  test-cross-platform:
    name: Cross-Platform Compatibility Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Android tools (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y android-tools-adb

      - name: Install Android tools (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install android-platform-tools

      - name: Install Android tools (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install adb -y
        shell: pwsh

      - name: Build native binary
        run: |
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            cargo build --release --features "native-binary,ios-support"
          else
            cargo build --release --features native-binary
          fi
        shell: bash

      - name: Verify binary runs
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            timeout 5 ./target/release/mobile-device-mcp-server.exe || true
          else
            timeout 5 ./target/release/mobile-device-mcp-server || true
          fi
        shell: bash

      - name: Test device listing (no devices)
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"mobile_device_mcp_list_available_devices","arguments":{}}}' | \
            timeout 10 ./target/release/mobile-device-mcp-server* | head -20
        shell: bash
        continue-on-error: true

  test-wasm:
    name: WASM Extension Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Build WASM extension
        run: cargo build --release --target wasm32-wasip1

      - name: Verify WASM binary
        run: |
          ls -lh target/wasm32-wasip1/release/mobile_device_mcp.wasm
          file target/wasm32-wasip1/release/mobile_device_mcp.wasm

      - name: Install wasmtime
        run: |
          curl https://wasmtime.dev/install.sh -sSf | bash
          echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH

      - name: Validate WASM binary
        run: |
          wasmtime --version
          wasmtime validate target/wasm32-wasip1/release/mobile_device_mcp.wasm

  summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [test-android, test-ios-simulator, test-cross-platform, test-wasm]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Integration tests completed"
          echo "Android tests: ${{ needs.test-android.result }}"
          echo "iOS tests: ${{ needs.test-ios-simulator.result }}"
          echo "Cross-platform tests: ${{ needs.test-cross-platform.result }}"
          echo "WASM tests: ${{ needs.test-wasm.result }}"

          if [ "${{ needs.test-android.result }}" = "failure" ] || \
             [ "${{ needs.test-ios-simulator.result }}" = "failure" ] || \
             [ "${{ needs.test-cross-platform.result }}" = "failure" ] || \
             [ "${{ needs.test-wasm.result }}" = "failure" ]; then
            echo "Some tests failed"
            exit 1
          fi
